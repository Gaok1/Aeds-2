O Código está um pouco confuso, mas é possivel compreender. sua logica poderia ser mais simples para maior entendimento;